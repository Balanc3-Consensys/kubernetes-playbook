{
  "kind": "Service",
  "apiVersion": "v1",
  "metadata":{
     "name": "{{item.name}}"
      {% if item.annotations is defined %}
      , "annotations":{
        {% for key, value in item.annotations.iteritems() %}
          "{{ key }}":"{{ value | to_json | regex_replace('(?<!\\\)\"','\\\"') }}"
          {% if not loop.last %}, {% endif %}
        {% endfor %}
      }
      {% endif %}
      {% if item.pod is defined and item.pod.canary is defined %}
      , "labels": {
        "canary_pct": "{{item.pod.canary.pct_traffic|default('1')}}",
        "primary_pct": "{{100 - item.pod.canary.pct_traffic|default('1')}}"
      }
      {% endif %}
  },
  "spec":{
     {% if item.clusterIP is defined %}
     "clusterIP": "{{ item.clusterIP }}",
     {% endif %}

     {% if item.ports is defined %}
     "ports":
        {{ item.ports | to_nice_json }}
     {% endif %}

     {% if item.pod is defined and item.pod.containers is defined %}
     ,
     "selector": {
       "name": "{{item.name}}"
     }
     {% elif item.selector is defined%}
     ,
     "selector":
        {{ item.selector | to_nice_json }}
     {% endif %}
     
     {% if item.type is defined %}
     ,
     "type": "{{ item.type }}"
     {% endif %}
  }
}
